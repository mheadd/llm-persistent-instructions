name: CI - Tests & Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-scan:
    name: Unit & Integration Tests + Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: api/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./api
      run: npm ci
        
    - name: ğŸ”¬ Run unit tests
      working-directory: ./api
      run: |
        echo "ğŸ”¬ Running unit tests..."
        npm test -- --testPathPattern="config.test.js" --ci --verbose=false
        
    - name: ğŸ”— Run integration tests  
      working-directory: ./api
      run: |
        echo "ğŸ”— Running integration tests..."
        npm test -- --testPathPattern="api.test.js" --ci --verbose=false
        
    - name: ğŸ›¡ï¸ Security scan - npm audit
      working-directory: ./api
      run: |
        echo "ğŸ›¡ï¸ Scanning dependencies for security vulnerabilities..."
        npm audit --audit-level=moderate
        
    - name: ğŸ“Š Generate coverage report
      working-directory: ./api
      run: |
        echo "ğŸ“Š Generating test coverage..."
        npm run test:coverage -- --testPathPattern="(config|api).test.js" --ci --silent
        
    - name: ï¿½ Upload coverage artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-coverage
        path: api/coverage/
        retention-days: 7
        
    - name: ğŸ“‹ Summary
      if: always()
      run: |
        echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | âœ… Completed |" >> $GITHUB_STEP_SUMMARY

  # Dependency review for pull requests
  dependency-review:
    name: Dependency Security Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        comment-summary-in-pr: true
