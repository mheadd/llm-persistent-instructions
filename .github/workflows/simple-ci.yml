name: Test & Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20.x'

jobs:
  test-and-security:
    name: Run Tests & Security Scans
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: api/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./api
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci --only=production
        npm install --only=dev
        
    - name: ğŸ”¬ Run Unit Tests
      working-directory: ./api
      run: |
        echo "ğŸ”¬ Running unit tests..."
        npm test -- --testPathPattern="config.test.js" --ci --verbose=false
        
    - name: ğŸ”— Run Integration Tests
      working-directory: ./api
      run: |
        echo "ğŸ”— Running integration tests..."
        npm test -- --testPathPattern="api.test.js" --ci --verbose=false
        
    - name: ğŸ›¡ï¸ NPM Audit - Security Scan
      working-directory: ./api
      run: |
        echo "ğŸ›¡ï¸ Running npm audit for security vulnerabilities..."
        echo "Checking for vulnerabilities at 'moderate' level and above..."
        npm audit --audit-level=moderate || {
          echo "âš ï¸ Security vulnerabilities found. Details above."
          echo "Run 'npm audit fix' to attempt automatic fixes."
          exit 1
        }
        echo "âœ… No security vulnerabilities found at moderate level or above."
        
    - name: ğŸ“Š Generate Test Coverage
      working-directory: ./api
      run: |
        echo "ğŸ“Š Generating test coverage report..."
        npm run test:coverage -- --testPathPattern="(config|api).test.js" --ci --silent
        
    - name: ğŸ” Package Analysis
      working-directory: ./api
      run: |
        echo "ğŸ” Analyzing package dependencies..."
        echo "## Dependency Analysis" > ../dependency-report.md
        echo "### Installed Packages" >> ../dependency-report.md
        npm list --depth=0 >> ../dependency-report.md
        echo "" >> ../dependency-report.md
        echo "### Security Audit Summary" >> ../dependency-report.md
        npm audit --format json > audit-results.json || true
        if [ -f audit-results.json ]; then
          echo "Audit completed. Check for any vulnerabilities in the logs above." >> ../dependency-report.md
        fi
        
    - name: ğŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-coverage-report
        path: |
          api/coverage/
          dependency-report.md
        retention-days: 30
        
    - name: ğŸ“‹ Job Summary
      if: always()
      run: |
        echo "## ğŸ§ª CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan (npm audit) | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Coverage | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js Version | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test coverage reports available in job artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency analysis report generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Quick Actions" >> $GITHUB_STEP_SUMMARY
        echo "- [View Coverage Report](../artifacts)" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Test Results](../artifacts)" >> $GITHUB_STEP_SUMMARY

  # Optional: Additional security scanning for pull requests
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        comment-summary-in-pr: true
